---
// src/pages/dashboard/index.astro
import DashboardHeader from './components/DashboardHeader.astro';
import PatientFilter from './components/PatientFilter.astro';
import PatientCard from './components/PatientCard.astro';
import { onMount } from 'solid-js';

let patients = [];
let error = null;
let isLoading = true;

onMount(async () => {
  try {
    const res = await fetch('/fhir/Patient');
    if (!res.ok) {
      throw new Error(`HTTP error! status: ${res.status}`);
    }
    const data = await res.json();
    // Ensure we have a proper array of patients
    patients = Array.isArray(data?.entry) 
      ? data.entry.map(entry => entry.resource || {})
      : [];
  } catch (err) {
    console.error('Error fetching patients:', err);
    error = err.message;
  } finally {
    isLoading = false;
  }
});

function handleFilter(query) {
  if (!query) return patients;
  return patients.filter(p => {
    const name = p.name?.[0]?.given?.[0]?.toLowerCase() || '';
    const identifier = p.identifier?.[0]?.value?.toLowerCase() || '';
    return name.includes(query.toLowerCase()) || 
           identifier.includes(query.toLowerCase());
  });
}
---

<DashboardHeader title="Visor Clínico Pediátrico" />

{isLoading ? (
  <div class="flex justify-center p-8">
    <span class="loading loading-spinner loading-lg"></span>
  </div>
) : error ? (
  <div class="alert alert-error">
    <span>Error al cargar los pacientes: {error}</span>
  </div>
) : (
  <>
    <PatientFilter onFilter={handleFilter} />
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
      {patients.length > 0 ? (
        patients.map(patient => (
          <PatientCard patient={patient} />
        ))
      ) : (
        <div class="col-span-3 text-center py-8">
          <p>No se encontraron pacientes</p>
        </div>
      )}
    </div>
  </>
)}