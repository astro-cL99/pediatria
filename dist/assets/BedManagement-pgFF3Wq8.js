import{r,s as n,_ as t,j as e,$ as x,aD as u,ap as C,aq as y,ar as _,as as S,at as o,ao as k,m as w,o as E,p as A,aS as L,n as D,ay as R}from"./index-CHTwuzBj.js";import{D as U,e as z,a as G,b as M,c as X}from"./dialog-BFKKEVrD.js";import{U as P}from"./user-plus-Bh9wLDzI.js";function K(){const[B,q]=r.useState([]),[i,T]=r.useState([]),[c,g]=r.useState(""),[l,j]=r.useState(""),[m,p]=r.useState("1"),[f,b]=r.useState(!1),[I,N]=r.useState(!1);r.useEffect(()=>{O(),h()},[]);const O=async()=>{try{const{data:s,error:a}=await n.from("patients").select("id, name, rut, status, admission_date").eq("status","active").order("admission_date",{ascending:!1});if(a)throw a;q(s||[])}catch(s){console.error("Error fetching patients:",s),t.error("Error al cargar pacientes")}},h=async()=>{try{const{data:s,error:a}=await n.from("bed_assignments").select(`
          *,
          patient:patients(name, rut),
          admission:admissions(id)
        `).eq("is_active",!0).order("room_number").order("bed_number");if(a)throw a;T(s||[])}catch(s){console.error("Error fetching bed assignments:",s),t.error("Error al cargar asignaciones")}},H=async()=>{if(!c||!l||!m){t.error("Complete todos los campos");return}b(!0);try{const{data:s,error:a}=await n.from("admissions").select("id").eq("patient_id",c).eq("status","active").single();if(a)throw a;const{error:v}=await n.from("bed_assignments").insert({patient_id:c,admission_id:s.id,room_number:l,bed_number:parseInt(m),is_active:!0});if(v)throw v;t.success("Cama asignada exitosamente"),N(!1),g(""),j(""),p("1"),h()}catch(s){console.error("Error assigning bed:",s),t.error(s.message||"Error al asignar cama")}finally{b(!1)}},V=async s=>{try{const{error:a}=await n.from("bed_assignments").update({is_active:!1,discharged_at:new Date().toISOString()}).eq("id",s);if(a)throw a;t.success("Paciente dado de alta de la cama"),h()}catch(a){console.error("Error discharging bed:",a),t.error("Error al dar de alta")}},d=B.filter(s=>!i.some(a=>a.patient_id===s.id));return e.jsxs("div",{className:"container mx-auto p-6 space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold",children:"Gestión de Camas"}),e.jsx("p",{className:"text-muted-foreground",children:"Asignar y gestionar camas de pacientes"})]}),e.jsxs(U,{open:I,onOpenChange:N,children:[e.jsx(z,{asChild:!0,children:e.jsxs(x,{children:[e.jsx(P,{className:"mr-2 h-4 w-4"}),"Asignar Cama"]})}),e.jsxs(G,{children:[e.jsx(M,{children:e.jsx(X,{children:"Asignar Paciente a Cama"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(u,{children:"Paciente"}),e.jsxs(C,{value:c,onValueChange:g,children:[e.jsx(y,{children:e.jsx(_,{placeholder:"Seleccione paciente"})}),e.jsx(S,{children:d.map(s=>e.jsxs(o,{value:s.id,children:[s.name," - ",s.rut]},s.id))})]})]}),e.jsxs("div",{children:[e.jsx(u,{children:"Número de Habitación"}),e.jsx(k,{placeholder:"501, 502, 601...",value:l,onChange:s=>j(s.target.value)})]}),e.jsxs("div",{children:[e.jsx(u,{children:"Subcama"}),e.jsxs(C,{value:m,onValueChange:p,children:[e.jsx(y,{children:e.jsx(_,{})}),e.jsxs(S,{children:[e.jsx(o,{value:"1",children:"1"}),e.jsx(o,{value:"2",children:"2"}),e.jsx(o,{value:"3",children:"3"})]})]})]}),e.jsx(x,{onClick:H,disabled:f,className:"w-full",children:f?"Asignando...":"Asignar Cama"})]})]})]})]}),e.jsxs("div",{className:"grid md:grid-cols-2 gap-6",children:[e.jsxs(w,{children:[e.jsx(E,{children:e.jsxs(A,{className:"flex items-center",children:[e.jsx(L,{className:"mr-2 h-5 w-5"}),"Camas Asignadas (",i.length,")"]})}),e.jsx(D,{children:e.jsx("div",{className:"space-y-2",children:i.length===0?e.jsx("p",{className:"text-muted-foreground text-center py-4",children:"No hay camas asignadas"}):i.map(s=>e.jsxs("div",{className:"flex items-center justify-between p-3 border rounded-lg",children:[e.jsxs("div",{children:[e.jsxs("p",{className:"font-semibold",children:["Cama ",s.room_number,"-",s.bed_number]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:s.patient.name})]}),e.jsx(x,{variant:"ghost",size:"sm",onClick:()=>V(s.id),children:e.jsx(R,{className:"h-4 w-4"})})]},s.id))})})]}),e.jsxs(w,{children:[e.jsx(E,{children:e.jsxs(A,{className:"flex items-center",children:[e.jsx(P,{className:"mr-2 h-5 w-5"}),"Pacientes Sin Cama (",d.length,")"]})}),e.jsx(D,{children:e.jsx("div",{className:"space-y-2",children:d.length===0?e.jsx("p",{className:"text-muted-foreground text-center py-4",children:"Todos los pacientes tienen cama asignada"}):d.map(s=>e.jsxs("div",{className:"p-3 border rounded-lg",children:[e.jsx("p",{className:"font-semibold",children:s.name}),e.jsx("p",{className:"text-sm text-muted-foreground",children:s.rut})]},s.id))})})]})]})]})}export{K as default};
