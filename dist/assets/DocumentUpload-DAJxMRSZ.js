import{ag as oe,s as _,ah as ie,_ as O,a as ce,r as f,j as e,P as G,k as K,F as L,ai as le,B as k,a7 as X,aj as W,ak as J,al as Z,am as Y,m as b,o as C,p as D,q as P,n as $,an as de,ao as me,ap as ue,aq as xe,ar as pe,as as he,at as U,$ as F,au as ge,av as fe,aw as je,ax as ve,ay as Ne,a0 as V,v as be}from"./index-CHTwuzBj.js";import{u as we}from"./useQuery-BmdVUKZ_.js";import{u as ye}from"./useMutation-D4Ezob1i.js";import{T as _e,a as Ce,b as B,c as T,d as De,e as A}from"./table-Bx6tkyc3.js";import{D as Pe,a as Ee,b as Se,c as Te,d as Ae}from"./dialog-BFKKEVrD.js";import{E as Fe}from"./eye-8LsxB1rk.js";import{C as ke}from"./circle-check-D84dMSvo.js";function Le(s){return we({queryKey:["clinical-documents",s],queryFn:async()=>{let t=_.from("clinical_documents").select("*").order("uploaded_at",{ascending:!1});const{data:c,error:i}=await t;if(i)throw i;return c}})}function $e(){const s=oe();return ye({mutationFn:async({file:t,patientId:c,admissionId:i})=>{const{data:{user:o}}=await _.auth.getUser();if(!o)throw new Error("No autenticado");t.name.split(".").pop();const w=t.name.replace(/[^a-zA-Z0-9.-]/g,"_").replace(/_{2,}/g,"_"),N=`${Date.now()}_${w}`,m=`${o.id}/${N}`,{error:u}=await _.storage.from("medical-documents").upload(m,t);if(u)throw u;let p=[];if(t.type==="application/pdf"){const j=await ie(()=>import("./pdf-DIYpjvCE.js"),[]);j.GlobalWorkerOptions.workerSrc=`https://cdn.jsdelivr.net/npm/pdfjs-dist@${j.version}/build/pdf.worker.min.mjs`;const r=await t.arrayBuffer(),h=await j.getDocument({data:r}).promise;for(let g=1;g<=Math.min(h.numPages,10);g++){const v=await h.getPage(g),a=v.getViewport({scale:2}),n=window.document.createElement("canvas"),l=n.getContext("2d");if(!l)continue;n.height=a.height,n.width=a.width,await v.render({canvasContext:l,viewport:a,intent:"display"}).promise;const x=n.toDataURL("image/png");p.push(x.split(",")[1])}}const{data:d,error:y}=await _.functions.invoke("classify-and-extract",{body:{imageBase64List:p.length>0?p:void 0,imageBase64:p[0],fileName:t.name}});if(y)throw y;if(!(d!=null&&d.success))throw new Error((d==null?void 0:d.error)||"Error al procesar documento");const{data:E,error:S}=await _.from("clinical_documents").insert({patient_id:c,admission_id:i,document_type:d.documentType,file_name:t.name,file_path:m,extracted_data:d.extractedData,uploaded_by:o.id,confidence_score:d.confidenceScore,processed:!1}).select().single();if(S)throw S;return _.functions.invoke("generate-embeddings",{body:{documentIds:[E.id]}}).catch(j=>console.error("Error generando embeddings:",j)),E},onSuccess:()=>{O.success("Documento procesado exitosamente"),s.invalidateQueries({queryKey:["clinical-documents"]})},onError:t=>{O.error(t.message||"Error al subir documento")}})}var z="Progress",I=100,[Re,Ze]=ce(z),[Me,ze]=Re(z),ee=f.forwardRef((s,t)=>{const{__scopeProgress:c,value:i=null,max:o,getValueLabel:w=Ie,...N}=s;(o||o===0)&&!q(o)&&console.error(Oe(`${o}`,"Progress"));const m=q(o)?o:I;i!==null&&!H(i,m)&&console.error(Ue(`${i}`,"Progress"));const u=H(i,m)?i:null,p=R(u)?w(u,m):void 0;return e.jsx(Me,{scope:c,value:u,max:m,children:e.jsx(G.div,{"aria-valuemax":m,"aria-valuemin":0,"aria-valuenow":R(u)?u:void 0,"aria-valuetext":p,role:"progressbar","data-state":te(u,m),"data-value":u??void 0,"data-max":m,...N,ref:t})})});ee.displayName=z;var se="ProgressIndicator",ae=f.forwardRef((s,t)=>{const{__scopeProgress:c,...i}=s,o=ze(se,c);return e.jsx(G.div,{"data-state":te(o.value,o.max),"data-value":o.value??void 0,"data-max":o.max,...i,ref:t})});ae.displayName=se;function Ie(s,t){return`${Math.round(s/t*100)}%`}function te(s,t){return s==null?"indeterminate":s===t?"complete":"loading"}function R(s){return typeof s=="number"}function q(s){return R(s)&&!isNaN(s)&&s>0}function H(s,t){return R(s)&&!isNaN(s)&&s<=t&&s>=0}function Oe(s,t){return`Invalid prop \`max\` of value \`${s}\` supplied to \`${t}\`. Only numbers greater than 0 are valid max values. Defaulting to \`${I}\`.`}function Ue(s,t){return`Invalid prop \`value\` of value \`${s}\` supplied to \`${t}\`. The \`value\` prop must be:
  - a positive number
  - less than the value passed to \`max\` (or ${I} if no \`max\` prop is set)
  - \`null\` or \`undefined\` if the progress is indeterminate.

Defaulting to \`null\`.`}var re=ee,Ve=ae;const ne=f.forwardRef(({className:s,value:t,...c},i)=>e.jsx(re,{ref:i,className:K("relative h-4 w-full overflow-hidden rounded-full bg-secondary",s),...c,children:e.jsx(Ve,{className:"h-full w-full flex-1 bg-primary transition-all",style:{transform:`translateX(-${100-(t||0)}%)`}})}));ne.displayName=re.displayName;const Be=({document:s,open:t,onOpenChange:c})=>s?e.jsx(Pe,{open:t,onOpenChange:c,children:e.jsxs(Ee,{className:"max-w-3xl max-h-[80vh]",children:[e.jsxs(Se,{children:[e.jsxs(Te,{className:"flex items-center gap-2",children:[e.jsx(L,{className:"h-5 w-5"}),s.file_name]}),e.jsx(Ae,{children:"Detalles del documento procesado con IA"})]}),e.jsx(le,{className:"max-h-[60vh] pr-4",children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground mb-1",children:"Tipo de Documento"}),e.jsx(k,{variant:"outline",children:s.document_type})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground mb-1",children:"Confianza del Procesamiento"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"h-2 w-24 bg-muted rounded-full overflow-hidden",children:e.jsx("div",{className:"h-full bg-primary",style:{width:`${(s.confidence_score||0)*100}%`}})}),e.jsxs("span",{className:"text-sm font-medium",children:[((s.confidence_score||0)*100).toFixed(0),"%"]})]})]}),e.jsxs("div",{children:[e.jsxs("p",{className:"text-sm font-medium text-muted-foreground mb-1 flex items-center gap-1",children:[e.jsx(X,{className:"h-3 w-3"}),"Fecha de Carga"]}),e.jsx("p",{className:"text-sm",children:W(new Date(s.uploaded_at),"dd/MM/yyyy HH:mm",{locale:J})})]}),e.jsxs("div",{children:[e.jsxs("p",{className:"text-sm font-medium text-muted-foreground mb-1 flex items-center gap-1",children:[e.jsx(Z,{className:"h-3 w-3"}),"Estado"]}),e.jsx(k,{variant:s.processed?"default":"secondary",children:s.processed?"Procesado":"Pendiente"})]})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-semibold mb-3",children:"Datos Extraídos por IA"}),e.jsx("div",{className:"bg-muted/30 rounded-lg p-4",children:s.extracted_data&&Object.keys(s.extracted_data).length>0?e.jsx("pre",{className:"text-xs whitespace-pre-wrap",children:JSON.stringify(s.extracted_data,null,2)}):e.jsx("p",{className:"text-sm text-muted-foreground italic",children:"No se extrajeron datos de este documento"})})]}),s.notes&&e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-semibold mb-2",children:"Notas"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:s.notes})]}),s.patient_id&&e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-semibold mb-2",children:"Paciente Asignado"}),e.jsxs("p",{className:"text-sm",children:["ID: ",s.patient_id]})]})]})})]})}):null,Q={laboratorio:"bg-blue-500/10 text-blue-700 border-blue-500/20",imagenología:"bg-purple-500/10 text-purple-700 border-purple-500/20",epicrisis:"bg-green-500/10 text-green-700 border-green-500/20",evolución:"bg-orange-500/10 text-orange-700 border-orange-500/20",anamnesis:"bg-pink-500/10 text-pink-700 border-pink-500/20",otro:"bg-gray-500/10 text-gray-700 border-gray-500/20"},qe=({documents:s,isLoading:t})=>{const[c,i]=f.useState(""),[o,w]=f.useState("all"),[N,m]=f.useState(null),[u,p]=f.useState(!1),{toast:d}=Y(),y=s.filter(r=>{const h=r.file_name.toLowerCase().includes(c.toLowerCase()),g=o==="all"||r.document_type===o;return h&&g}),E=Array.from(new Set(s.map(r=>r.document_type))),S=r=>{m(r),p(!0)},j=async r=>{try{const{data:h,error:g}=await _.storage.from("medical-documents").download(r.file_path);if(g)throw g;const v=window.URL.createObjectURL(h),a=document.createElement("a");a.href=v,a.download=r.file_name,document.body.appendChild(a),a.click(),window.URL.revokeObjectURL(v),document.body.removeChild(a),d({title:"Descarga iniciada",description:`Se está descargando ${r.file_name}`})}catch(h){d({title:"Error al descargar",description:h.message,variant:"destructive"})}};return t?e.jsxs(b,{children:[e.jsxs(C,{children:[e.jsx(D,{children:"Documentos Procesados"}),e.jsx(P,{children:"Cargando documentos desde la base de datos..."})]}),e.jsx($,{children:e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsx("div",{className:"animate-pulse text-muted-foreground",children:"Cargando..."})})})]}):e.jsxs(b,{children:[e.jsxs(C,{children:[e.jsxs(D,{children:["Documentos Procesados (",s.length,")"]}),e.jsx(P,{children:"Historial completo de documentos cargados y procesados con IA"})]}),e.jsxs($,{children:[e.jsxs("div",{className:"flex flex-col sm:flex-row gap-4 mb-6",children:[e.jsxs("div",{className:"flex-1 relative",children:[e.jsx(de,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(me,{placeholder:"Buscar por nombre de archivo...",value:c,onChange:r=>i(r.target.value),className:"pl-9"})]}),e.jsxs(ue,{value:o,onValueChange:w,children:[e.jsx(xe,{className:"w-full sm:w-[200px]",children:e.jsx(pe,{placeholder:"Tipo de documento"})}),e.jsxs(he,{children:[e.jsx(U,{value:"all",children:"Todos los tipos"}),E.map(r=>e.jsx(U,{value:r,children:r.charAt(0).toUpperCase()+r.slice(1)},r))]})]})]}),y.length===0?e.jsxs("div",{className:"text-center py-12",children:[e.jsx(L,{className:"h-12 w-12 mx-auto text-muted-foreground mb-4"}),e.jsx("p",{className:"text-muted-foreground",children:s.length===0?"No hay documentos procesados aún":"No se encontraron documentos con los filtros aplicados"})]}):e.jsx("div",{className:"border rounded-lg",children:e.jsxs(_e,{children:[e.jsx(Ce,{children:e.jsxs(B,{children:[e.jsx(T,{children:"Archivo"}),e.jsx(T,{children:"Tipo"}),e.jsx(T,{children:"Confianza"}),e.jsx(T,{children:"Fecha"}),e.jsx(T,{className:"text-right",children:"Acciones"})]})}),e.jsx(De,{children:y.map(r=>e.jsxs(B,{children:[e.jsx(A,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(L,{className:"h-4 w-4 text-muted-foreground shrink-0"}),e.jsxs("div",{className:"min-w-0",children:[e.jsx("p",{className:"font-medium truncate",children:r.file_name}),r.patient_id&&e.jsxs("p",{className:"text-xs text-muted-foreground flex items-center gap-1 mt-1",children:[e.jsx(Z,{className:"h-3 w-3"}),"Asignado a paciente"]})]})]})}),e.jsx(A,{children:e.jsx(k,{variant:"outline",className:Q[r.document_type]||Q.otro,children:r.document_type})}),e.jsx(A,{children:r.confidence_score?e.jsx("div",{className:"space-y-1",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ne,{value:r.confidence_score*100,className:"h-2 w-20"}),e.jsxs("span",{className:"text-sm text-muted-foreground",children:[(r.confidence_score*100).toFixed(0),"%"]})]})}):e.jsx("span",{className:"text-muted-foreground text-sm",children:"-"})}),e.jsx(A,{children:e.jsxs("div",{className:"flex items-center gap-1 text-sm text-muted-foreground",children:[e.jsx(X,{className:"h-3 w-3"}),W(new Date(r.uploaded_at),"dd/MM/yyyy HH:mm",{locale:J})]})}),e.jsx(A,{className:"text-right",children:e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx(F,{variant:"ghost",size:"sm",title:"Ver detalles",onClick:()=>S(r),children:e.jsx(Fe,{className:"h-4 w-4"})}),e.jsx(F,{variant:"ghost",size:"sm",title:"Descargar",onClick:()=>j(r),children:e.jsx(ge,{className:"h-4 w-4"})})]})})]},r.id))})]})})]}),e.jsx(Be,{document:N,open:u,onOpenChange:p})]})},Ye=()=>{const[s,t]=f.useState([]),c=$e(),{data:i=[],isLoading:o,refetch:w}=Le(),{toast:N}=Y(),m=f.useCallback(a=>{const n=a.map(l=>({file:l,status:"pending"}));t(l=>[...l,...n])},[]),{getRootProps:u,getInputProps:p,isDragActive:d}=fe({onDrop:m,accept:{"application/pdf":[".pdf"],"application/vnd.openxmlformats-officedocument.wordprocessingml.document":[".docx"],"application/vnd.ms-excel":[".xls"],"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet":[".xlsx"]}}),y=async()=>{for(let a=0;a<s.length;a++)if(s[a].status==="pending"){t(n=>n.map((l,x)=>x===a?{...l,status:"processing"}:l));try{const n=await c.mutateAsync({file:s[a].file});t(l=>l.map((x,M)=>M===a?{...x,status:"success",result:n}:x)),N({title:"Documento procesado",description:`${s[a].file.name} se procesó correctamente`})}catch(n){t(l=>l.map((x,M)=>M===a?{...x,status:"error",error:n.message}:x)),N({title:"Error al procesar",description:n.message,variant:"destructive"})}}setTimeout(()=>{w()},1e3)};f.useEffect(()=>{if(s.filter(n=>n.status==="success").length>0){const n=setTimeout(()=>{t(l=>l.filter(x=>x.status!=="success"))},3e3);return()=>clearTimeout(n)}},[s]);const E=()=>{t(a=>a.filter(n=>n.status!=="success"))},S=a=>{t(n=>n.filter((l,x)=>x!==a))},j=a=>{switch(a){case"processing":return e.jsx(V,{className:"h-4 w-4 animate-spin"});case"success":return e.jsx(ke,{className:"h-4 w-4 text-green-500"});case"error":return e.jsx(be,{className:"h-4 w-4 text-destructive"});default:return e.jsx(L,{className:"h-4 w-4"})}},r=s.filter(a=>a.status==="pending").length,h=s.filter(a=>a.status==="success").length,g=s.filter(a=>a.status==="error").length,v=s.filter(a=>a.status==="processing").length;return e.jsx(je,{children:e.jsxs("div",{className:"container mx-auto p-6 space-y-6",children:[e.jsxs("div",{className:"grid gap-6 md:grid-cols-4",children:[e.jsx(b,{children:e.jsxs(C,{className:"pb-2",children:[e.jsx(P,{children:"Pendientes"}),e.jsx(D,{className:"text-2xl",children:r})]})}),e.jsx(b,{children:e.jsxs(C,{className:"pb-2",children:[e.jsx(P,{children:"Procesando"}),e.jsx(D,{className:"text-2xl",children:v})]})}),e.jsx(b,{children:e.jsxs(C,{className:"pb-2",children:[e.jsx(P,{children:"Exitosos"}),e.jsx(D,{className:"text-2xl text-green-600",children:h})]})}),e.jsx(b,{children:e.jsxs(C,{className:"pb-2",children:[e.jsx(P,{children:"Errores"}),e.jsx(D,{className:"text-2xl text-destructive",children:g})]})})]}),e.jsxs(b,{children:[e.jsxs(C,{children:[e.jsx(D,{children:"Carga Masiva de Documentos"}),e.jsx(P,{children:"Sube múltiples documentos médicos (PDF, Word, Excel) para procesamiento automático con IA"})]}),e.jsxs($,{children:[e.jsxs("div",{...u(),className:K("border-2 border-dashed rounded-lg p-12 text-center cursor-pointer transition-colors",d?"border-primary bg-primary/5":"border-muted-foreground/25 hover:border-primary/50"),children:[e.jsx("input",{...p()}),e.jsx(ve,{className:"h-12 w-12 mx-auto mb-4 text-muted-foreground"}),d?e.jsx("p",{className:"text-lg",children:"Suelta los archivos aquí..."}):e.jsxs("div",{children:[e.jsx("p",{className:"text-lg font-medium",children:"Arrastra archivos aquí o haz clic para seleccionar"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-2",children:"Puedes subir múltiples archivos a la vez"})]})]}),s.length>0&&e.jsxs("div",{className:"mt-6 space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("h3",{className:"font-medium",children:["Archivos en Cola (",s.length,")"]}),e.jsxs("div",{className:"flex gap-2",children:[h>0&&e.jsxs(F,{variant:"outline",size:"sm",onClick:E,children:[e.jsx(Ne,{className:"mr-2 h-4 w-4"}),"Limpiar Exitosos"]}),r>0&&e.jsx(F,{onClick:y,disabled:v>0,children:v>0?e.jsxs(e.Fragment,{children:[e.jsx(V,{className:"mr-2 h-4 w-4 animate-spin"}),"Procesando..."]}):e.jsxs(e.Fragment,{children:["Procesar Todos (",r,")"]})})]})]}),e.jsx("div",{className:"space-y-2",children:s.map((a,n)=>e.jsx(b,{children:e.jsx($,{className:"p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3 flex-1",children:[j(a.status),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"font-medium truncate",children:a.file.name}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:[(a.file.size/1024).toFixed(2)," KB"]}),a.result&&e.jsxs("div",{className:"flex gap-2 mt-2",children:[e.jsx(k,{variant:"outline",children:a.result.document_type}),e.jsxs(k,{variant:"secondary",children:["Confianza: ",(a.result.confidence_score*100).toFixed(0),"%"]})]}),a.error&&e.jsxs("p",{className:"text-sm text-destructive mt-1",children:["Error: ",a.error]})]})]}),a.status==="pending"&&e.jsx(F,{variant:"ghost",size:"sm",onClick:()=>S(n),children:"Eliminar"})]})})},n))})]})]})]}),e.jsx(qe,{documents:i,isLoading:o})]})})};export{Ye as default};
